#!/usr/bin/env python3
"""
BoramClaw ê°„í¸ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
ì‚¬ìš©ë²•:
  boram today       # ì˜¤ëŠ˜ ì‘ì—… ë¦¬í¬íŠ¸ (ê¸°ë³¸) + í…”ë ˆê·¸ë¨ ì „ì†¡
  boram week        # ì´ë²ˆ ì£¼ ì‘ì—… ë¦¬í¬íŠ¸ + í…”ë ˆê·¸ë¨ ì „ì†¡
  boram today-diff  # ì˜¤ëŠ˜ ì‘ì—… + ì½”ë“œ diff + í…”ë ˆê·¸ë¨ ì „ì†¡
  boram week-diff   # ì´ë²ˆ ì£¼ + ì½”ë“œ diff + í…”ë ˆê·¸ë¨ ì „ì†¡
"""
import sys
import json
import subprocess
import os
from pathlib import Path
from datetime import datetime, timedelta
from zoneinfo import ZoneInfo

# KST íƒ€ì„ì¡´
KST = ZoneInfo("Asia/Seoul")

TOOL_PATH = Path(__file__).parent / "tools" / "workday_recap.py"
TELEGRAM_TOOL_PATH = Path(__file__).parent / "tools" / "telegram_send_message.py"

def print_report(mode: str, include_diff: bool = False):
    """ë¦¬í¬íŠ¸ ì‹¤í–‰ ë° í¬ë§·íŒ…"""
    cmd = [
        "python3", str(TOOL_PATH),
        "--tool-input-json", json.dumps({
            "mode": mode,
            "scan_all_repos": True,
            "include_diff": include_diff
        }),
        "--tool-context-json", "{}"
    ]

    result = subprocess.run(cmd, capture_output=True, text=True)

    if result.returncode != 0:
        print(f"âŒ ì˜¤ë¥˜: {result.stderr}")
        sys.exit(1)

    data = json.loads(result.stdout)
    report = data.get("report", {})
    sections = report.get("sections", {})
    timeline = report.get("timeline", {})

    # í—¤ë” (KST ê¸°ì¤€)
    now = datetime.now(KST)
    print(f"\n{'='*70}")
    if mode == "daily":
        weekday = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† ", "ì¼"][now.weekday()]
        print(f"ğŸ“Š {now.month}/{now.day}({weekday}) ì‘ì—… íšŒê³ ")
        print(f"â° {now.strftime('%H:%M')} KST")
    else:
        week_start = now - timedelta(days=6)
        print(f"ğŸ“Š ì£¼ê°„ ì‘ì—… íšŒê³  (Week {now.isocalendar()[1]})")
        print(f"ğŸ“… {week_start.strftime('%m/%d')} ~ {now.strftime('%m/%d')}")
        print(f"â° {now.strftime('%H:%M')} KST")
    print(f"{'='*70}\n")

    # Git
    if "git" in sections:
        git = sections["git"]
        total_commits = git['total_commits']

        if mode == "daily":
            print(f"ğŸ’» ê°œë°œ í™œë™ (ì˜¤ëŠ˜)")
            print(f"   ì €ì¥ì†Œ: {git['repositories']}ê°œ | ì»¤ë°‹: {total_commits}ê°œ")
            print(f"   ì½”ë“œ: +{git['insertions']}ì¤„ -{git['deletions']}ì¤„")
            print(f"   íŒŒì¼: {git.get('files_changed', 0)}ê°œ ìˆ˜ì •\n")

            # ì˜¤ëŠ˜ ì»¤ë°‹ ìƒì„¸
            for i, c in enumerate(git.get("commits", [])[:5], 1):
                # KST ì‹œê°„ìœ¼ë¡œ ë³€í™˜
                date_str = c.get("date", "")
                if date_str and "T" in date_str:
                    try:
                        dt = datetime.fromisoformat(date_str).astimezone(KST)
                        time = dt.strftime("%H:%M")
                    except:
                        time = date_str.split("T")[1].split("+")[0][:5]
                else:
                    time = ""

                files = c.get("files", [])
                file_count = len(files)
                print(f"{i}. [{time}] {c.get('message', '')[:60]} ({file_count}ê°œ íŒŒì¼)")

                # íŒŒì¼ ëª©ë¡
                if files and len(files) <= 5:
                    for f in files:
                        status = f["status"]
                        icon = {"A": "â•", "M": "âœï¸", "D": "ğŸ—‘ï¸"}.get(status, "â€¢")
                        print(f"      {icon} {f['file']}")
                elif files:
                    for f in files[:3]:
                        status = f["status"]
                        icon = {"A": "â•", "M": "âœï¸", "D": "ğŸ—‘ï¸"}.get(status, "â€¢")
                        print(f"      {icon} {f['file']}")
                    print(f"      ... ì™¸ {len(files)-3}ê°œ")
                print()

        else:
            # Weekly: ìš”ì•½ + í†µê³„ + ì¸ì‚¬ì´íŠ¸
            print(f"ğŸ’» ê°œë°œ í™œë™ (7ì¼ê°„)")
            print(f"   ì €ì¥ì†Œ: {git['repositories']}ê°œ")
            print(f"   ì´ ì»¤ë°‹: {total_commits}ê°œ")

            # ìƒì‚°ì„± ë¶„ì„
            avg_per_day = total_commits / 7
            if avg_per_day >= 3:
                productivity = "ğŸ”¥ ë§¤ìš° í™œë°œ"
            elif avg_per_day >= 1.5:
                productivity = "âœ… ê¾¸ì¤€í•¨"
            elif avg_per_day >= 0.5:
                productivity = "ğŸ¢ ëŠë¦¼"
            else:
                productivity = "ğŸ˜´ ê±°ì˜ ì—†ìŒ"

            print(f"   í•˜ë£¨ í‰ê· : {avg_per_day:.1f}ê°œ ({productivity})")
            print(f"   ì½”ë“œ ë³€ê²½: +{git['insertions']}ì¤„ -{git['deletions']}ì¤„")

            # ìˆœì¦ê° ë¶„ì„
            net_change = git['insertions'] - git['deletions']
            if net_change > 500:
                print(f"   ğŸ’¡ ëŒ€ê·œëª¨ ê¸°ëŠ¥ ì¶”ê°€ (+{net_change}ì¤„)")
            elif net_change < -500:
                print(f"   ğŸ§¹ ëŒ€ê·œëª¨ ë¦¬íŒ©í† ë§ (-{abs(net_change)}ì¤„)")
            elif net_change > 0:
                print(f"   ğŸ“ˆ ì ì§„ì  ì„±ì¥ (+{net_change}ì¤„)")
            else:
                print(f"   âš–ï¸ ê· í˜•ì¡íŒ ìˆ˜ì • ({net_change}ì¤„)")
            print()

            # ì¼ë³„ í™œë™ ë¶„í¬
            print("ğŸ“… ì¼ë³„ í™œë™ ë¶„í¬:")
            commits_by_day = {}
            for c in git.get("commits", []):
                date = c.get("date", "").split("T")[0] if "T" in c.get("date", "") else ""
                if date:
                    if date not in commits_by_day:
                        commits_by_day[date] = []
                    commits_by_day[date].append(c)

            sorted_days = sorted(commits_by_day.items(), key=lambda x: x[0], reverse=True)
            for date, day_commits in sorted_days[:7]:
                try:
                    dt_kst = datetime.fromisoformat(day_commits[0]["date"]).astimezone(KST)
                    day_name = dt_kst.strftime("%m/%d(%a)")
                except:
                    day_name = date

                bar = "â–“" * min(len(day_commits), 20)
                print(f"  {day_name}: {bar:<20} {len(day_commits)}ê°œ")
            print()

            # ê°€ì¥ í™œë°œí–ˆë˜ ë‚  TOP 3
            print("ğŸ† ìµœê³  ìƒì‚°ì„± TOP 3:")
            top_days = sorted(commits_by_day.items(), key=lambda x: len(x[1]), reverse=True)[:3]
            for rank, (date, day_commits) in enumerate(top_days, 1):
                try:
                    dt_kst = datetime.fromisoformat(day_commits[0]["date"]).astimezone(KST)
                    day_name = dt_kst.strftime("%m/%d(%a)")
                except:
                    day_name = date

                medal = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰"][rank-1]
                print(f"  {medal} {day_name}: {len(day_commits)}ê°œ ì»¤ë°‹")
                for c in day_commits[:2]:
                    print(f"    â€¢ {c['message'][:50]}")
            print()

    # Timeline + ìƒì‚°ì„± íŒ¨í„´
    if timeline and timeline.get("peak_hour") is not None:
        peak_hour = timeline['peak_hour']
        peak_count = timeline['peak_count']
        active_hours = timeline.get("active_hours", [])

        print(f"â° ìƒì‚°ì„± íŒ¨í„´")
        print(f"   í”¼í¬ ì‹œê°„: {peak_hour:02d}:00 ({peak_count}ê±´)")

        # ì‹œê°„ëŒ€ë³„ ë¶„ë¥˜
        morning = [h for h in active_hours if 6 <= h < 12]
        afternoon = [h for h in active_hours if 12 <= h < 18]
        evening = [h for h in active_hours if 18 <= h < 22]
        night = [h for h in active_hours if h >= 22 or h < 6]

        if mode == "weekly":
            work_patterns = []
            if morning:
                work_patterns.append(f"ğŸŒ… ì˜¤ì „í˜• ({len(morning)}ì‹œê°„)")
            if afternoon:
                work_patterns.append(f"â˜€ï¸ ì˜¤í›„í˜• ({len(afternoon)}ì‹œê°„)")
            if evening:
                work_patterns.append(f"ğŸŒ† ì €ë…í˜• ({len(evening)}ì‹œê°„)")
            if night:
                work_patterns.append(f"ğŸŒ™ ì•¼ê°„í˜• ({len(night)}ì‹œê°„)")

            if work_patterns:
                print(f"   ì‘ì—… ìœ í˜•: {', '.join(work_patterns)}")

            # ì¶”ì²œ
            if len(evening) + len(night) > len(morning) + len(afternoon):
                print(f"   ğŸ’¡ ì•¼ê°„ ì‘ì—…ì´ ë§ë„¤ìš”. ìˆ˜ë©´ íŒ¨í„´ ì²´í¬!")
            elif len(morning) > len(afternoon):
                print(f"   âœ¨ ì˜¤ì „ ì§‘ì¤‘í˜•! ì¤‘ìš”í•œ ì¼ì€ ì˜¤ì „ì—!")

        # ì‹œê°„ëŒ€ë³„ ë§‰ëŒ€ ê·¸ë˜í”„
        print()
        hourly = timeline.get("hourly", {})
        max_count = max([d.get("total", 0) for d in hourly.values()] or [1])
        for hour in active_hours:
            data = hourly.get(str(hour), {})
            total = data.get("total", 0)
            bar_width = int((total / max_count) * 40)
            bar = "â–ˆ" * bar_width
            period_icon = "ğŸŒ…" if 6 <= hour < 12 else "â˜€ï¸" if 12 <= hour < 18 else "ğŸŒ†" if 18 <= hour < 22 else "ğŸŒ™"
            print(f"   {period_icon} {hour:02d}:00  {bar:<40} {total}ê±´")
        print()

    # Browser
    if "browser" in sections:
        browser = sections["browser"]
        if mode == "daily":
            print(f"ğŸŒ ì›¹ í™œë™ (ì˜¤ëŠ˜ {browser['total_visits']}ê°œ í˜ì´ì§€)")
            for cluster in browser.get("page_titles", [])[:3]:
                print(f"   â€¢ {cluster['domain']} ({cluster['page_count']}íšŒ)")
                for title in cluster["titles"][:1]:
                    print(f"     â”” {title[:60]}")
        else:
            print(f"ğŸŒ ì›¹ í™œë™ (7ì¼ê°„ {browser['total_visits']}ê°œ í˜ì´ì§€)")
            print(f"   í•˜ë£¨ í‰ê· : {browser['total_visits']/7:.0f}ê°œ")
            for cluster in browser.get("page_titles", [])[:2]:
                print(f"   â€¢ {cluster['domain']} ({cluster['page_count']}íšŒ)")
        print()

    # Shell
    if "shell" in sections:
        shell = sections["shell"]
        if mode == "daily":
            print(f"ğŸ–¥ï¸ í„°ë¯¸ë„ (ì˜¤ëŠ˜ {shell['total_commands']}ê°œ ëª…ë ¹ì–´)")
            for cmd in shell.get("top_commands", [])[:5]:
                print(f"   â€¢ {cmd['command']:30s} {cmd['count']}íšŒ")
        else:
            print(f"ğŸ–¥ï¸ í„°ë¯¸ë„ (7ì¼ê°„ {shell['total_commands']}ê°œ ëª…ë ¹ì–´)")
            print(f"   í•˜ë£¨ í‰ê· : {shell['total_commands']/7:.0f}ê°œ")
            for cmd in shell.get("top_commands", [])[:3]:
                print(f"   â€¢ {cmd['command']:30s} {cmd['count']}íšŒ")
        print()

    # ë‹¤ìŒ ì•¡ì…˜ (Weekly only)
    if mode == "weekly":
        print(f"{'='*70}")
        print("ğŸ¯ ë‹¤ìŒ ì£¼ ì•¡ì…˜")
        print()

        # Git ê¸°ë°˜ ì¶”ì²œ
        if "git" in sections:
            git = sections["git"]
            avg_commits = git['total_commits'] / 7
            if avg_commits < 1:
                print("  â€¢ ì»¤ë°‹ ë¹ˆë„ ë†’ì´ê¸° (ì‘ì€ ë‹¨ìœ„ë¡œ ìì£¼)")
            elif avg_commits > 5:
                print("  â€¢ ì»¤ë°‹ í’ˆì§ˆ ì²´í¬ (ë„ˆë¬´ ì‘ê²Œ ìª¼ê°œì§€ ì•Šì•˜ë‚˜?)")

            recent_commits = git.get("commits", [])[:10]
            has_wip = any("WIP" in c.get("message", "").upper() or "TODO" in c.get("message", "").upper() for c in recent_commits)
            if has_wip:
                print("  â€¢ WIP/TODO ì»¤ë°‹ ì •ë¦¬í•˜ê¸°")

        # Shell ê¸°ë°˜ ì¶”ì²œ
        if "shell" in sections:
            shell = sections["shell"]
            top_cmds = shell.get("top_commands", [])
            if any(cmd["command"] in ["pytest", "npm test", "cargo test"] for cmd in top_cmds):
                print("  â€¢ âœ… í…ŒìŠ¤íŠ¸ ìŠµê´€ ìœ ì§€ ì¤‘!")
            else:
                print("  â€¢ í…ŒìŠ¤íŠ¸ ì‘ì„± ê³ ë ¤í•˜ê¸°")

        # Browser ê¸°ë°˜ ì¶”ì²œ
        if "browser" in sections:
            browser = sections["browser"]
            if browser['total_visits'] > 300:
                print("  â€¢ ì›¹ ì„œí•‘ ì‹œê°„ ì¤„ì´ê¸° (ì§‘ì¤‘ë ¥ í–¥ìƒ)")

        # Timeline ê¸°ë°˜ ì¶”ì²œ
        if timeline and timeline.get("peak_hour"):
            peak = timeline['peak_hour']
            if peak < 8 or peak > 22:
                print("  â€¢ ì‘ì—… ì‹œê°„ ì •ìƒí™” (ê±´ê°• ìš°ì„ )")

        print()
        print("ğŸ“š ì£¼ë§ í•™ìŠµ ì¶”ì²œ:")

        # í”„ë¡œì íŠ¸/ê¸°ìˆ  ìŠ¤íƒ ê°ì§€ ë° í•™ìŠµ ì¶”ì²œ
        learning_topics = []

        if "git" in sections:
            git = sections["git"]
            all_commits = git.get("commits", [])
            all_messages = " ".join([c.get("message", "") for c in all_commits]).lower()

            # í‚¤ì›Œë“œ ê¸°ë°˜ í”„ë¡œì íŠ¸ ê°ì§€
            if "telegram" in all_messages or "bot" in all_messages:
                learning_topics.append("  â€¢ Telegram Bot API ê³ ê¸‰ ê¸°ëŠ¥ (inline buttons, webhooks)")
                learning_topics.append("  â€¢ ëŒ€í™”í˜• AI ë””ìì¸ íŒ¨í„´")

            if "mcp" in all_messages or "agent" in all_messages:
                learning_topics.append("  â€¢ React Agent ë…¼ë¬¸ ë³µìŠµ (Planning, Reasoning)")
                learning_topics.append("  â€¢ Multi-Agent ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜")

            if "queue" in all_messages or "lane" in all_messages or "serialize" in all_messages:
                learning_topics.append("  â€¢ LaneQueue íŒ¨í„´ê³¼ ë™ì‹œì„± ì œì–´")
                learning_topics.append("  â€¢ Request Serialization ì‹¤ë¬´ ì‚¬ë¡€")

            if "guardian" in all_messages or "watchdog" in all_messages or "4-tier" in all_messages:
                learning_topics.append("  â€¢ 4-Tier Reliability ì•„í‚¤í…ì²˜ ì‹¬í™”")
                learning_topics.append("  â€¢ Self-Healing ì‹œìŠ¤í…œ ì„¤ê³„")

            if "screenpipe" in all_messages or "ocr" in all_messages:
                learning_topics.append("  â€¢ Computer Visionê³¼ OCR ìµœì í™”")
                learning_topics.append("  â€¢ ë¡œì»¬ ë°ì´í„° ì••ì¶• ì•Œê³ ë¦¬ì¦˜")

            # íŒŒì¼ í™•ì¥ì ê¸°ë°˜
            all_files = []
            for c in all_commits:
                all_files.extend([f.get("file", "") for f in c.get("files", [])])

            file_exts = {f.split(".")[-1] for f in all_files if "." in f}

            if "py" in file_exts:
                if "async" in all_messages or "await" in all_messages:
                    learning_topics.append("  â€¢ Python asyncio ê³ ê¸‰ íŒ¨í„´")

            if "ts" in file_exts or "tsx" in file_exts:
                learning_topics.append("  â€¢ TypeScript ê³ ê¸‰ íƒ€ì… ì‹œìŠ¤í…œ")

            if "rs" in file_exts:
                learning_topics.append("  â€¢ Rust ì†Œìœ ê¶Œê³¼ ë¼ì´í”„íƒ€ì„")

        # í•™ìŠµ ì£¼ì œ ì¶œë ¥
        if learning_topics:
            for topic in learning_topics[:4]:
                print(topic)
        else:
            print("  â€¢ ì´ë²ˆ ì£¼ ì‘ì—…í•œ ì½”ë“œ ë¦¬ë·° ë° ë¦¬íŒ©í† ë§")
            print("  â€¢ ê´€ë ¨ ê¸°ìˆ  ë¸”ë¡œê·¸/ë…¼ë¬¸ ì½ê¸°")

        print()

    print(f"{'='*70}")
    if mode == "daily":
        print("ğŸ’¬ './boram week'ìœ¼ë¡œ ì£¼ê°„ íšŒê³  ë³´ê¸°")
    else:
        print("ğŸš€ ìƒì‚°ì ì¸ í•œ ì£¼ ë˜ì„¸ìš”!")
    print(f"{'='*70}\n")

    # í…”ë ˆê·¸ë¨ ì „ì†¡
    send_to_telegram(report, mode, include_diff)


def send_to_telegram(report: dict, mode: str, include_diff: bool):
    """ë¦¬í¬íŠ¸ë¥¼ í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì „ì†¡"""
    # .envì—ì„œ ì„¤ì • í™•ì¸
    env_file = Path(__file__).parent / ".env"
    if not env_file.exists():
        return

    telegram_enabled = False
    for line in env_file.read_text().split("\n"):
        line = line.strip()
        if line.startswith("TELEGRAM_ENABLED=") and not line.startswith("#"):
            telegram_enabled = line.split("=", 1)[1].strip() == "1"
            break

    if not telegram_enabled:
        return

    # í…”ë ˆê·¸ë¨ìš© ê°„ëµí•œ ë©”ì‹œì§€ ìƒì„±
    period = "ì˜¤ëŠ˜" if mode == "daily" else "ì´ë²ˆ ì£¼"
    sections = report.get("sections", {})

    lines = [f"ğŸ“Š {period} ì‘ì—… ë¦¬í¬íŠ¸", ""]

    # Git
    if "git" in sections:
        git = sections["git"]
        lines.append(f"ğŸ’» ê°œë°œ í™œë™")
        lines.append(f"   ì €ì¥ì†Œ: {git['repositories']}ê°œ | ì»¤ë°‹: {git['total_commits']}ê°œ")
        lines.append(f"   ì½”ë“œ: +{git['insertions']}ì¤„ -{git['deletions']}ì¤„")
        lines.append("")

        for i, c in enumerate(git.get("commits", [])[:3], 1):
            date = c["date"].split("T")[0]
            time = c["date"].split("T")[1].split("+")[0][:5]
            lines.append(f"{i}. [{c['repo']}] {c['message'][:50]}")

            files = c.get("files", [])
            if files and len(files) <= 3:
                for f in files:
                    status_icon = {"A": "â•", "M": "âœï¸", "D": "ğŸ—‘ï¸"}.get(f["status"], "â€¢")
                    lines.append(f"   {status_icon} {f['file'][:40]}")
        lines.append("")

    # Timeline
    timeline = report.get("timeline", {})
    if timeline and timeline.get("peak_hour") is not None:
        lines.append(f"â° í”¼í¬ ì‹œê°„: {timeline['peak_hour']:02d}:00 ({timeline['peak_count']}ê±´)")
        lines.append("")

    # Browser
    if "browser" in sections:
        browser = sections["browser"]
        lines.append(f"ğŸŒ ì›¹: {browser['total_visits']}ê°œ í˜ì´ì§€ ë°©ë¬¸")
        for cluster in browser.get("page_titles", [])[:2]:
            lines.append(f"   â€¢ {cluster['domain']} ({cluster['page_count']}íšŒ)")
        lines.append("")

    # Shell
    if "shell" in sections:
        shell = sections["shell"]
        lines.append(f"ğŸ–¥ï¸ í„°ë¯¸ë„: {shell['total_commands']}ê°œ ëª…ë ¹ì–´")
        for cmd in shell.get("top_commands", [])[:3]:
            lines.append(f"   â€¢ {cmd['command'][:30]} ({cmd['count']}íšŒ)")

    message = "\n".join(lines)

    # í…”ë ˆê·¸ë¨ ì „ì†¡
    try:
        cmd = [
            "python3", str(TELEGRAM_TOOL_PATH),
            "--tool-input-json", json.dumps({"text": message}),
            "--tool-context-json", "{}"
        ]
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=10)
        if result.returncode == 0:
            print("âœ… í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì „ì†¡ ì™„ë£Œ!\n")
        else:
            print(f"âš ï¸  í…”ë ˆê·¸ë¨ ì „ì†¡ ì‹¤íŒ¨: {result.stderr}\n")
    except Exception as e:
        print(f"âš ï¸  í…”ë ˆê·¸ë¨ ì „ì†¡ ì˜¤ë¥˜: {e}\n")


def main():
    if len(sys.argv) < 2:
        print_report("daily")
        return

    cmd = sys.argv[1].lower()

    if cmd in ["today", "ì˜¤ëŠ˜"]:
        print_report("daily")
    elif cmd in ["week", "ì£¼ê°„", "ì´ë²ˆì£¼"]:
        print_report("weekly")
    elif cmd in ["today-diff", "ì˜¤ëŠ˜-diff"]:
        print_report("daily", include_diff=True)
    elif cmd in ["week-diff", "ì£¼ê°„-diff"]:
        print_report("weekly", include_diff=True)
    else:
        print(__doc__)
        sys.exit(1)


if __name__ == "__main__":
    main()
