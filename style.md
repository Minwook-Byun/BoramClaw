# 코딩 스타일 가이드

이 문서는 OpenClaw 지향 에이전트 개발을 위한 프로젝트 표준이다.
규칙은 간결하게 유지하고, 충돌 시 보안/안정성 규칙이 우선한다.

## 1) 최상위 목표
- 목표는 "설명형 챗봇"이 아니라 "실행형 에이전트"다.
- 사람 개입 없이 도구를 탐색/추가/수정/실행할 수 있는 구조를 우선한다.
- OpenClaw 개발에 실질적 도움이 없는 구현은 하지 않는다.

## 2) 아키텍처 원칙
- `main.py`에 고정 `import tools.xxx`를 두지 않는다.
- 도구는 `tools/*.py`를 파일시스템에서 동적으로 발견해 로딩한다.
- 툴 추가/삭제/수정은 실행 중(Runtime) 즉시 반영 가능해야 한다.
- 툴 인터페이스는 `TOOL_SPEC` + `run(input_data, context)`를 기본으로 한다.
- 장기 상태가 필요하면 `create(context)` + `obj.run(...)` + `close()` 수명주기를 지원한다.

## 3) 보안 원칙 (필수)
- 기본값은 `STRICT_WORKDIR_ONLY=1`이다.
- 상위 디렉토리 접근(`..`), 절대경로, 홈/환경변수 경로 확장은 차단한다.
- `run_shell`은 셸 메타문자 체이닝/리다이렉션을 허용하지 않는다.
- `run_python`은 strict 모드에서 비활성화한다.
- 파일 쓰기/삭제/이동/권한 변경은 workdir 바깥에서 절대 허용하지 않는다.

## 4) API 비용 최적화 원칙
- 모든 툴 스키마를 매번 API에 보내지 않는다.
- 사용자 프롬프트 의도에 맞는 `tools_schema` 부분집합만 선택해 전달한다.
- 선택 결과는 캐시해 유사 요청에서 재사용한다.
- 출력에는 선택 수/전체 수, 문자량 절감율, 캐시 히트율을 포함한다.

## 5) Python 스타일
- PEP 8 준수, 타입 힌트 기본 적용.
- 함수/변수는 `snake_case`, 클래스는 `PascalCase`.
- 상수는 파일 상단에 명시하고 매직 값 하드코딩을 줄인다.
- 긴 함수는 역할 단위로 분리하고, 도구 실행/검증/직렬화 책임을 분리한다.

## 6) 에러 처리
- 실패는 숨기지 말고 구조화된 에러로 반환한다.
- `except Exception`은 경계층(루프/런타임 보호)에서만 제한적으로 사용한다.
- 에러 메시지는 원인 파악에 필요한 정보만 포함하고, 키/토큰/민감 경로는 노출하지 않는다.

## 7) 출력/로그 원칙
- 사용자 콘솔 출력은 최소화한다.
- 불필요한 진행 로그/디버그 프린트는 금지한다.
- 로그는 JSONL로 누적하고 UTC ISO-8601 타임스탬프를 사용한다.
- 최소 이벤트: `session_start`, `user_prompt`, `tool_schema_selection`, `tool_call`, `tool_result`, `assistant_output`, `error_output`, `session_end`.

## 8) 성능 원칙
- 파일 스캔은 가볍게 수행하고 변경 파일만 재로딩한다.
- 불필요한 import/reload 반복을 피하고, 런타임 객체를 재사용한다.
- 외부 API 연결은 가능한 재사용한다.

## 9) 검증 원칙
- 코드 수정 후 최소 검증: `python3 -m py_compile main.py`.
- 보안/동적 로딩 수정 시 핵심 스모크 테스트를 추가로 수행한다.
- 테스트는 빠르게 끝나고 재현 가능해야 한다.

## 10) 리뷰 체크리스트
- 이번 변경이 OpenClaw 목표에 직접 기여하는가?
- 동적 로딩/런타임 반영을 깨지 않았는가?
- strict 보안 제약을 우회하는 경로가 생기지 않았는가?
- API 비용 최적화(스키마 선별/캐시) 흐름을 깨지 않았는가?
- 불필요한 출력/죽은 코드가 남아 있지 않은가?
